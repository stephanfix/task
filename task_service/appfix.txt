from flask import Flask, request, jsonify
from flask_cors import CORS
import sqlite3
import os
from datetime import datetime
import requests
import traceback
import sys

app = Flask(__name__)
CORS(app)

# Database configuration
DATABASE = os.getenv('DATABASE', '/app/data/tasks.db')
USER_SERVICE_URL = os.getenv('USER_SERVICE_URL', 'http://localhost:5001')

def get_db_connection():
    """Create a database connection"""
    conn = sqlite3.connect(DATABASE)
    conn.row_factory = sqlite3.Row
    return conn

def init_db():
    """Initialize the database with required tables"""
    print("Initializing database...", file=sys.stderr)
    
    # Ensure data directory exists
    os.makedirs(os.path.dirname(DATABASE), exist_ok=True)
    
    conn = sqlite3.connect(DATABASE)
    cursor = conn.cursor()
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS tasks (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            title TEXT NOT NULL,
            description TEXT,
            priority TEXT DEFAULT 'medium',
            status TEXT DEFAULT 'pending',
            due_date TIMESTAMP,
            created_at TIMESTAMP,
            updated_at TIMESTAMP
        )
    ''')
    
    conn.commit()
    conn.close()
    print("Database initialized successfully!", file=sys.stderr)

@app.route('/health', methods=['GET'])
def health_check():
    """Health check endpoint for Kubernetes probes"""
    try:
        # Test database connection
        conn = get_db_connection()
        conn.execute('SELECT 1')
        conn.close()
        
        # Test user service connection
        try:
            response = requests.get(f'{USER_SERVICE_URL}/health', timeout=2)
            user_service_healthy = response.status_code == 200
        except:
            user_service_healthy = False
        
        if user_service_healthy:
            return jsonify({
                'status': 'healthy',
                'service': 'task-service',
                'dependencies': {
                    'user-service': 'healthy'
                },
                'timestamp': datetime.now().isoformat()
            }), 200
        else:
            return jsonify({
                'status': 'degraded',
                'service': 'task-service',
                'dependencies': {
                    'user-service': 'unhealthy'
                },
                'timestamp': datetime.now().isoformat()
            }), 200
            
    except Exception as e:
        return jsonify({
            'status': 'unhealthy',
            'service': 'task-service',
            'error': str(e),
            'timestamp': datetime.now().isoformat()
        }), 503

@app.route('/api/tasks', methods=['GET', 'POST', 'OPTIONS'])
def tasks():
    """Get all tasks for a user or create a new task"""
    # Handle CORS preflight
    if request.method == 'OPTIONS':
        return '', 200
    
    if request.method == 'GET':
        try:
            user_id = request.args.get('user_id')
            
            if not user_id:
                return jsonify({'error': 'user_id is required'}), 400
            
            conn = get_db_connection()
            cursor = conn.cursor()
            
            cursor.execute('SELECT * FROM tasks WHERE user_id = ? ORDER BY created_at DESC', (user_id,))
            tasks = cursor.fetchall()
            conn.close()
            
            tasks_list = []
            for task in tasks:
                tasks_list.append({
                    'id': task['id'],
                    'user_id': task['user_id'],
                    'title': task['title'],
                    'description': task['description'],
                    'priority': task['priority'],
                    'status': task['status'],
                    'due_date': task['due_date'],
                    'created_at': task['created_at'],
                    'updated_at': task['updated_at']
                })
            
            return jsonify({'tasks': tasks_list}), 200
            
        except Exception as e:
            print(f"Get tasks error: {str(e)}", file=sys.stderr)
            traceback.print_exc(file=sys.stderr)
            return jsonify({'error': 'Internal server error'}), 500
    
    elif request.method == 'POST':
        try:
            data = request.get_json()
            
            if not data:
                return jsonify({'error': 'No JSON data provided'}), 400
            
            user_id = data.get('user_id')
            title = data.get('title')
            description = data.get('description', '')
            priority = data.get('priority', 'medium')
            status = data.get('status', 'pending')
            due_date = data.get('due_date')
            
            if not user_id or not title:
                return jsonify({'error': 'user_id and title are required'}), 400
            
            conn = get_db_connection()
            cursor = conn.cursor()
            
            # Explicitly set timestamps
            now = datetime.now().isoformat()
            
            cursor.execute('''
                INSERT INTO tasks (user_id, title, description, priority, status, due_date, created_at, updated_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ''', (user_id, title, description, priority, status, due_date, now, now))
            
            conn.commit()
            task_id = cursor.lastrowid
            conn.close()
            
            return jsonify({
                'message': 'Task created successfully',
                'task': {
                    'id': task_id,
                    'user_id': user_id,
                    'title': title,
                    'description': description,
                    'priority': priority,
                    'status': status,
                    'due_date': due_date
                }
            }), 201
            
        except Exception as e:
            print(f"Create task error: {str(e)}", file=sys.stderr)
            traceback.print_exc(file=sys.stderr)
            return jsonify({'error': 'Internal server error'}), 500

@app.route('/api/tasks/<int:task_id>', methods=['GET', 'PUT', 'DELETE', 'OPTIONS'])
def task_detail(task_id):
    """Get, update, or delete a specific task"""
    # Handle CORS preflight
    if request.method == 'OPTIONS':
        return '', 200
    
    if request.method == 'GET':
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            
            cursor.execute('SELECT * FROM tasks WHERE id = ?', (task_id,))
            task = cursor.fetchone()
            conn.close()
            
            if task:
                return jsonify({
                    'task': {
                        'id': task['id'],
                        'user_id': task['user_id'],
                        'title': task['title'],
                        'description': task['description'],
                        'priority': task['priority'],
                        'status': task['status'],
                        'due_date': task['due_date'],
                        'created_at': task['created_at'],
                        'updated_at': task['updated_at']
                    }
                }), 200
            else:
                return jsonify({'error': 'Task not found'}), 404
                
        except Exception as e:
            print(f"Get task error: {str(e)}", file=sys.stderr)
            traceback.print_exc(file=sys.stderr)
            return jsonify({'error': 'Internal server error'}), 500
    
    elif request.method == 'PUT':
        try:
            data = request.get_json()
            
            if not data:
                return jsonify({'error': 'No JSON data provided'}), 400
            
            conn = get_db_connection()
            cursor = conn.cursor()
            
            # Build dynamic update query
            update_fields = []
            values = []
            
            if 'title' in data:
                update_fields.append('title = ?')
                values.append(data['title'])
            if 'description' in data:
                update_fields.append('description = ?')
                values.append(data['description'])
            if 'priority' in data:
                update_fields.append('priority = ?')
                values.append(data['priority'])
            if 'status' in data:
                update_fields.append('status = ?')
                values.append(data['status'])
            if 'due_date' in data:
                update_fields.append('due_date = ?')
                values.append(data['due_date'])
            
            # Always update updated_at
            update_fields.append('updated_at = ?')
            values.append(datetime.now().isoformat())
            
            values.append(task_id)
            
            query = f"UPDATE tasks SET {', '.join(update_fields)} WHERE id = ?"
            cursor.execute(query, values)
            conn.commit()
            conn.close()
            
            return jsonify({'message': 'Task updated successfully'}), 200
            
        except Exception as e:
            print(f"Update task error: {str(e)}", file=sys.stderr)
            traceback.print_exc(file=sys.stderr)
            return jsonify({'error': 'Internal server error'}), 500
    
    elif request.method == 'DELETE':
        try:
            conn = get_db_connection()
            cursor = conn.cursor()
            
            cursor.execute('DELETE FROM tasks WHERE id = ?', (task_id,))
            conn.commit()
            conn.close()
            
            return jsonify({'message': 'Task deleted successfully'}), 200
            
        except Exception as e:
            print(f"Delete task error: {str(e)}", file=sys.stderr)
            traceback.print_exc(file=sys.stderr)
            return jsonify({'error': 'Internal server error'}), 500

@app.route('/api/tasks/stats/<int:user_id>', methods=['GET'])
def task_stats(user_id):
    """Get task statistics for a user"""
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Total tasks
        cursor.execute('SELECT COUNT(*) as count FROM tasks WHERE user_id = ?', (user_id,))
        total_tasks = cursor.fetchone()['count']
        
        # Tasks by status
        cursor.execute('SELECT status, COUNT(*) as count FROM tasks WHERE user_id = ? GROUP BY status', (user_id,))
        status_counts = cursor.fetchall()
        
        by_status = {}
        for row in status_counts:
            by_status[row['status']] = row['count']
        
        # Overdue tasks
        cursor.execute('''
            SELECT COUNT(*) as count FROM tasks 
            WHERE user_id = ? AND due_date < ? AND status != 'completed'
        ''', (user_id, datetime.now().isoformat()))
        overdue_tasks = cursor.fetchone()['count']
        
        conn.close()
        
        return jsonify({
            'total_tasks': total_tasks,
            'by_status': by_status,
            'overdue_tasks': overdue_tasks
        }), 200
        
    except Exception as e:
        print(f"Stats error: {str(e)}", file=sys.stderr)
        traceback.print_exc(file=sys.stderr)
        return jsonify({'error': 'Internal server error'}), 500

if __name__ == '__main__':
    print(f"Starting task service...", file=sys.stderr)
    print(f"Database path: {DATABASE}", file=sys.stderr)
    print(f"User service URL: {USER_SERVICE_URL}", file=sys.stderr)
    init_db()