version: '3.8'

services:
  # User Service
  user-service:
    build: ./user_service
    ports:
      - "${USER_SERVICE_PORT:-5001}:5001"
    volumes:
      # Persist SQLite database
      - ./data/user_service:/app/data
    env_file:
      # Load environment variables from file
      - ./user_service/.env.${ENVIRONMENT:-development}
    environment:
      # Override specific variables for Docker
      - FLASK_ENV=${ENVIRONMENT:-development}
      - DATABASE=/app/data/users.db
      - HOST=0.0.0.0
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - task-manager-network

  # Task Service  
  task-service:
    build: ./task_service
    ports:
      - "${TASK_SERVICE_PORT:-5002}:5002"
    volumes:
      # Persist SQLite database
      - ./data/task_service:/app/data
    env_file:
      - ./task_service/.env.${ENVIRONMENT:-development}
    environment:
      - FLASK_ENV=${ENVIRONMENT:-development}
      - DATABASE=/app/data/tasks.db
      - HOST=0.0.0.0
      # Use Docker service name for internal communication
      - USER_SERVICE_URL=http://user-service:5001
    depends_on:
      user-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - task-manager-network

  # Frontend (React App)
  frontend:
    build: 
      context: ./frontend
      args:
        # Pass build-time environment variables
        - REACT_APP_USER_SERVICE_URL=${REACT_APP_USER_SERVICE_URL:-http://localhost:5001/api}
        - REACT_APP_TASK_SERVICE_URL=${REACT_APP_TASK_SERVICE_URL:-http://localhost:5002/api}
        - REACT_APP_ENVIRONMENT=${ENVIRONMENT:-development}
    ports:
      - "3000:3000"
    depends_on:
      - user-service
      - task-service
    environment:
      # Runtime environment variables for the container
      - NODE_ENV=${ENVIRONMENT:-development}
    networks:
      - task-manager-network

# Named volumes for easier management and backup
volumes:
  user_data:
    driver: local
  task_data:  
    driver: local

# Custom network for service communication
networks:
  task-manager-network:
    driver: bridge